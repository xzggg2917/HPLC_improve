<!DOCTYPE html>
<html>
<head>
    <title>Acetonitrile S 值计算验证</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; background: #f0f0f0; }
        .correct { background: #d4edda; }
        .incorrect { background: #f8d7da; }
        table { border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #4CAF50; color: white; }
    </style>
</head>
<body>
    <h1>Acetonitrile S 值计算验证</h1>
    
    <h2>预定义数据（FactorsPage.tsx）</h2>
    <table>
        <tr>
            <th>参数</th>
            <th>值</th>
        </tr>
        <tr><td>density</td><td id="density">0.786</td></tr>
        <tr><td>releasePotential (S1)</td><td id="s1">0.615</td></tr>
        <tr><td>fireExplos (S2)</td><td id="s2">1.000</td></tr>
        <tr><td>reactDecom (S3)</td><td id="s3">0.600</td></tr>
        <tr><td>acuteToxicity (S4)</td><td id="s4">0.510</td></tr>
        <tr><td>safetyScore (预定义)</td><td id="predefined_s">2.724</td></tr>
    </table>

    <h2>您修改后的数据（来自截图）</h2>
    <div>请输入您在 Factors 表中修改后的实际值：</div>
    <table>
        <tr>
            <th>参数</th>
            <th>输入值</th>
        </tr>
        <tr><td>releasePotential (S1)</td><td><input type="number" id="input_s1" value="0.612" step="0.001"></td></tr>
        <tr><td>fireExplos (S2)</td><td><input type="number" id="input_s2" value="1.000" step="0.001"></td></tr>
        <tr><td>reactDecom (S3)</td><td><input type="number" id="input_s3" value="0.600" step="0.001"></td></tr>
        <tr><td>acuteToxicity (S4)</td><td><input type="number" id="input_s4" value="0.510" step="0.001"></td></tr>
    </table>
    <button onclick="calculate()">计算</button>

    <h2>Table 页面的计算（来自截图）</h2>
    <table>
        <tr>
            <th>参数</th>
            <th>值</th>
        </tr>
        <tr><td>Volume (ml)</td><td>2.000</td></tr>
        <tr><td>Density (g/ml)</td><td>0.786</td></tr>
        <tr><td>Mass (g)</td><td id="mass">1.572</td></tr>
        <tr><td>色谱类型</td><td><select id="chromatography">
            <option value="0.05">Nano_LC (0.05g)</option>
            <option value="4.0">UPLC (4.0g)</option>
            <option value="10.0">HPLC_MS (10.0g)</option>
            <option value="45.0" selected>HPLC_UV (45.0g)</option>
            <option value="250.0">Semi_prep (250.0g)</option>
        </select></td></tr>
        <tr><td><strong>截图显示 S 值</strong></td><td><strong style="color: red;">9.516</strong></td></tr>
    </table>

    <div id="results"></div>

    <script>
        function calculate() {
            const volume = 2.000;
            const density = 0.786;
            const mass = volume * density; // 1.572
            
            // 获取输入的子因子值
            const s1_factor = parseFloat(document.getElementById('input_s1').value);
            const s2_factor = parseFloat(document.getElementById('input_s2').value);
            const s3_factor = parseFloat(document.getElementById('input_s3').value);
            const s4_factor = parseFloat(document.getElementById('input_s4').value);
            
            const baselineMass = parseFloat(document.getElementById('chromatography').value);
            
            // 方法1：错误方法（直接对聚合的 safetyScore 归一化）
            const safetyScore_aggregated = s1_factor + s2_factor + s3_factor + s4_factor;
            const wrong_S = Math.min(100, (mass * safetyScore_aggregated / baselineMass) * 100);
            
            // 方法2：正确方法（每个子因子单独归一化后相加）
            const s1_normalized = Math.min(100, (mass * s1_factor / baselineMass) * 100);
            const s2_normalized = Math.min(100, (mass * s2_factor / baselineMass) * 100);
            const s3_normalized = Math.min(100, (mass * s3_factor / baselineMass) * 100);
            const s4_normalized = Math.min(100, (mass * s4_factor / baselineMass) * 100);
            const correct_S = s1_normalized + s2_normalized + s3_normalized + s4_normalized;
            
            let html = '<h2>计算结果</h2>';
            
            html += '<h3>基础信息</h3>';
            html += `<div class="result">质量 = ${volume} ml × ${density} g/ml = <strong>${mass.toFixed(3)} g</strong></div>`;
            html += `<div class="result">归一化基准质量 = <strong>${baselineMass} g</strong></div>`;
            html += `<div class="result">聚合 SafetyScore = ${s1_factor} + ${s2_factor} + ${s3_factor} + ${s4_factor} = <strong>${safetyScore_aggregated.toFixed(3)}</strong></div>`;
            
            html += '<h3>方法1：错误方法（修复前）</h3>';
            html += `<div class="result incorrect">`;
            html += `公式：S = (mass × safetyScore / baseline_mass) × 100<br>`;
            html += `计算：S = (${mass.toFixed(3)} × ${safetyScore_aggregated.toFixed(3)} / ${baselineMass}) × 100<br>`;
            html += `结果：S = <strong>${wrong_S.toFixed(3)}</strong>`;
            html += `</div>`;
            
            html += '<h3>方法2：正确方法（修复后）</h3>';
            html += `<div class="result correct">`;
            html += `<strong>每个子因子单独归一化：</strong><br>`;
            html += `S1 = (${mass.toFixed(3)} × ${s1_factor} / ${baselineMass}) × 100 = ${s1_normalized.toFixed(3)}<br>`;
            html += `S2 = (${mass.toFixed(3)} × ${s2_factor} / ${baselineMass}) × 100 = ${s2_normalized.toFixed(3)}<br>`;
            html += `S3 = (${mass.toFixed(3)} × ${s3_factor} / ${baselineMass}) × 100 = ${s3_normalized.toFixed(3)}<br>`;
            html += `S4 = (${mass.toFixed(3)} × ${s4_factor} / ${baselineMass}) × 100 = ${s4_normalized.toFixed(3)}<br>`;
            html += `<strong>总计：</strong> S = ${s1_normalized.toFixed(3)} + ${s2_normalized.toFixed(3)} + ${s3_normalized.toFixed(3)} + ${s4_normalized.toFixed(3)} = <strong>${correct_S.toFixed(3)}</strong>`;
            html += `</div>`;
            
            html += '<h3>与截图对比</h3>';
            const screenshot_value = 9.516;
            const diff_wrong = Math.abs(wrong_S - screenshot_value);
            const diff_correct = Math.abs(correct_S - screenshot_value);
            
            html += `<div class="result">截图显示的 S 值：<strong>${screenshot_value}</strong></div>`;
            html += `<div class="result ${diff_wrong < 0.01 ? 'incorrect' : ''}">方法1（错误）与截图差值：<strong>${diff_wrong.toFixed(3)}</strong></div>`;
            html += `<div class="result ${diff_correct < 0.01 ? 'correct' : ''}">方法2（正确）与截图差值：<strong>${diff_correct.toFixed(3)}</strong></div>`;
            
            html += '<h3>结论</h3>';
            if (diff_wrong < 0.01) {
                html += '<div class="result incorrect"><strong>截图显示的是修复前的错误计算结果！</strong><br>';
                html += '系统使用了错误的公式，直接对聚合后的 safetyScore 进行归一化。</div>';
            }
            if (diff_correct < 0.01) {
                html += '<div class="result correct"><strong>截图显示的是修复后的正确计算结果！</strong><br>';
                html += '系统正确地对每个子因子单独归一化后相加。</div>';
            }
            
            html += '<h3>说明</h3>';
            html += '<div class="result">';
            html += '<p><strong>错误方法的问题：</strong>将已经聚合的 safetyScore (S1+S2+S3+S4) 作为一个整体进行归一化，违背了 GEMAM 标准。</p>';
            html += '<p><strong>正确方法：</strong>按照 GEMAM 标准，应该对每个子因子（S1, S2, S3, S4）单独进行归一化，然后将归一化后的分数相加。</p>';
            html += '<p><strong>公式：</strong> S = min(100, (m×S1/baseline)×100) + min(100, (m×S2/baseline)×100) + min(100, (m×S3/baseline)×100) + min(100, (m×S4/baseline)×100)</p>';
            html += '</div>';
            
            document.getElementById('results').innerHTML = html;
        }
        
        // 页面加载时自动计算
        window.onload = calculate;
    </script>
</body>
</html>
